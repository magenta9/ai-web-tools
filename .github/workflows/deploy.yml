# Deploy to Server Workflow
# Pulls code to server and builds locally
name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.REMOTE_HOST }}
        username: ${{ secrets.REMOTE_USERNAME }}
        key: ${{ secrets.REMOTE_SSH_KEY }}
        port: ${{ secrets.REMOTE_SSH_PORT }}
        script: |
          echo "=== Deploying to Server ==="
          
          # Navigate to project directory
          cd /opt/webtools || mkdir -p /opt/webtools && cd /opt/webtools
          
          # Clone or pull latest code
          if [ -d "ai-web-tools" ]; then
            echo "Updating existing repository..."
            cd ai-web-tools
            git pull origin main
          else
            echo "Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git ai-web-tools
            cd ai-web-tools
          fi
          
          # Copy environment file if not exists
          if [ ! -f "server-go/.env" ]; then
            echo "Creating .env file..."
            cp server-go/.env.example server-go/.env
            echo "⚠️  Please configure server-go/.env with production values"
          fi
          
          # Build and start services
          echo "Building and starting services..."
          cd server-go
          docker compose -f docker/docker-compose.prod.yml build
          docker compose -f docker/docker-compose.prod.yml up -d
          
          # Wait for services to be healthy
          echo "Waiting for services to be healthy..."
          sleep 10
          
          # Health check
          if curl -sf http://localhost:3001/api/health > /dev/null; then
            echo "✅ Deployment successful!"
            docker compose -f docker/docker-compose.prod.yml ps
          else
            echo "❌ Health check failed!"
            docker compose -f docker/docker-compose.prod.yml logs --tail 50
            exit 1
          fi
          
          # Clean up old images
          docker image prune -f

    - name: Verify Deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.REMOTE_HOST }}
        username: ${{ secrets.REMOTE_USERNAME }}
        key: ${{ secrets.REMOTE_SSH_KEY }}
        port: ${{ secrets.REMOTE_SSH_PORT }}
        script: |
          echo "=== Deployment Status ==="
          cd /opt/webtools/ai-web-tools/server-go
          docker compose -f docker/docker-compose.prod.yml ps
          echo ""
          echo "Recent logs:"
          docker compose -f docker/docker-compose.prod.yml logs --tail 20